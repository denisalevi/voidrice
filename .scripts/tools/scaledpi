#!/bin/python

# This script takes care of setting different configs for HiDPI monitor
# switching. Currently only 2x scale implemented for Firefox, GTK 3 and
# Xressources.
# TODO: Qt 5 applications can also be scaled by setting
# export QT_AUTO_SCREEN_SCALE_FACTOR=1 (add to ~/.gtk-3-scale)
# https://wiki.archlinux.org/index.php/HiDPI#Qt_5
# TODO: 150% scaling can also be achieved by setting GDK_SCALE=2 (too big) and
# then reducing it with xrandr --scale 1.333x1.333 (uses screen scaling and
# takes non-integers)


### SCALING CONFIGS
##############################################################
# Thinkpad T480 screen, 150% scaling
config_2k = {
    # GDK 3 (GTK 3) icon scaling
    # GDK_SCALE only takes integers, so stay at 100%
    'GDK_SCALE': 1,
    'GDK_DPI_SCALE': 1,
    # Firefox
    'layout.css.devPixelsPerPx': 1.5,
    # Xressources
    'Xft.dpi': 140  # 150%
}

# 4k Dell monitor, 200% scaling
config_4k = {
    # GDK 3 (GTK 3) icon scaling
    'GDK_SCALE': 2,
    'GDK_DPI_SCALE': 0.5,
    # Firefox
    'layout.css.devPixelsPerPx': 2,
    # Xressources
    'Xft.dpi': 192
}
##############################################################


import argparse

parser = argparse.ArgumentParser(description="Set screen DPI scaling")
parser.add_argument('resolution', type=str, choices=['2k', '4k'],
                    help='Set the screen resolution')
args = parser.parse_args()

if args.resolution == '2k':
    config = config_2k
elif args.resolution == '4k':
    config = config_4k
else:
    assert False, 'argparse failed'

import subprocess
import os

def report(message, **kwargs):
    """ Python print and notify-send message. """
    print(message)
    subprocess.run(['notify-send', message], **kwargs)

# Set firefox
dppp = config['layout.css.devPixelsPerPx']
ret = subprocess.run([f'ff-set-preference',
                      'layout.css.devPixelsPerPx', f'{dppp}'], check=True)
if ret.returncode:
    msg = "ERROR setting layout.css.devPixelsPerPx"
else:
    msg = f"Firefox DPI:\n {dppp}"
report(msg)

# set GTK 3
gtk_config = f"""
# This file is generated by ~/.scripts/tools/scaledpi and changes will be
# overwritten at next run
# Changing these values will effect scaling in eclipse, which sources this file
# in ~/.config/aliasrc
export GDK_SCALE={config['GDK_SCALE']}
export GDK_DPI_SCALE={config['GDK_DPI_SCALE']}
"""
with open(os.path.expanduser('~/.gtk-3-scale'), 'w') as file:
    file.write(gtk_config)
report(f"GDK_SCALE={config['GDK_SCALE']}\n"
       f"GDK_DPI_SCALE={config['GDK_DPI_SCALE']}")

# Set Xressources
tmp_xressource = '/tmp/.Xressource-tmp'
with open(tmp_xressource, 'w') as file:
    file.write(f"Xft.dpi : {config['Xft.dpi']}")
ret = subprocess.run(['xrdb', '-merge', tmp_xressource])
if ret.returncode:
    msg = f"ERROR setting xrdb Xft.dpi"
else:
    msg = f"Xft.dpi:\n {config['Xft.dpi']}"
report(msg)

ret = subprocess.run(['remaps'])
if ret.returncode:
    report("ERROR in remaps")

ret = subprocess.run(['i3-msg', 'restart'], stdout= subprocess.DEVNULL)
if ret.returncode:
    msg = "ERROR restarting i3"
else:
    msg = "Restarted i3"
report(msg)
